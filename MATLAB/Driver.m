% Driver for IF network solver

% Parameter values
% thresholds
V_left  = -25.0;
V_right = 5.0;
V_r     = 0.0;
V_th    = 6.5;

alpha       = 0.5;
beta_left   = 0.94;
beta_right  = -0.06;
tau  = 1.0;
tau_h= 417.0;
tau_r = 20.0;
gh   = 165;
gs   = -2.1*(-85.0+65.0);
I    = 0.01;
sigma= 25.0;
W    = 1.0;
gamma_centre = (beta_right - beta_left)/(V_right - V_left);
beta_centre = -gamma_centre*V_left + beta_left;

% network size
N    = 1000;
eps  = 1e-10;

% Grid stuff
L  = 10*sigma;
dx = 2*L/(N-1);
spatial_extent = floor(sigma/(2*L/(N-1)));
full_mask = -spatial_extent:spatial_extent;
neuron_ind = 1:N;

% time options
dt = 0.1;
currentTime = 0.0;
finalTime   = 1000.0;

% options
options = optimset('Display','off','TolFun',1e-10);

% Functions to find crossing events
fun1 = @(t,v0,n0,u0,y0) v0*exp(-t/tau)...
  +(beta_left*gh*(tau-tau_h+tau_h*exp(-t/tau_h)))/(tau-tau_h)...
  -(beta_left*gh*tau*exp(-t/tau))/(tau-tau_h)...
  -(gh*n0*tau_h*exp(-t/tau_h))/(tau-tau_h)...
  +(gh*n0*tau_h*exp(-t/tau))/(tau-tau_h)...
  +(gs*exp(-alpha*t).*(alpha*tau*u0-u0-alpha*t*y0+alpha*tau*y0+alpha^2*t*tau*y0))/(alpha*tau-1)^2 ...
  -(gs*exp(-t/tau)*(alpha*tau*u0-u0+alpha*tau*y0))/(alpha*tau-1)^2 ...
  -I+I*exp(-t/tau)-V_left;

fun2 = @(t,v0,n0,u0,y0) (1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))+tau.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))+tau_h.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))-tau_h.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))).*(-v0+(beta_centre.*tau.^2.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(gamma_centre.*(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*-2.0+gamma_centre.*tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0+gamma_centre.*tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0)+(beta_centre.*tau_h.^2.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(gamma_centre.*(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*-2.0+gamma_centre.*tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0+gamma_centre.*tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0)+(I.*tau_h.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))+(I.*tau_h.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(I.*tau_h.^2.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau.*tau_h.*2.0+tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.^2-tau_h.^2-gamma_centre.*gh.*tau.*tau_h.*4.0)+(beta_centre.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(gamma_centre.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)))-(beta_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(-gamma_centre.*(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+gamma_centre.*tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+gamma_centre.*tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))+(gs.*tau_h.*u0.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)-(beta_centre.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(gamma_centre.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)))-alpha.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0+tau.*tau_h.*exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(t.*tau+t.*tau_h-tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0)+(alpha.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0+tau.*tau_h.*exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(t.*tau+t.*tau_h-tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*t.*tau.*tau_h.*2.0).*2.0).*(1.0./2.0))./tau+alpha.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0-tau.*tau_h.*exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(-t.*tau-t.*tau_h+tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0)+(alpha.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0-tau.*tau_h.*exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(-t.*tau-t.*tau_h+tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+alpha.*t.*tau.*tau_h.*2.0).*2.0).*(1.0./2.0))./tau+(I.*tau.*tau_h.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau.*tau_h.*2.0+tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.^2-tau_h.^2-gamma_centre.*gh.*tau.*tau_h.*4.0)+(I.*tau_h.^2.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(I.*tau.*tau_h.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(gs.*tau_h.^2.*u0.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)-(gs.*tau_h.*u0.*exp(-alpha.*t).*(exp(alpha.*t)-exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)-(beta_centre.*tau.^2.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(gamma_centre.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)))-(beta_centre.*tau_h.^2.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(gamma_centre.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)))+(alpha.*gs.*tau_h.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0+tau.*tau_h.*exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(t.*tau+t.*tau_h-tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./tau-(alpha.*gs.*tau_h.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0-tau.*tau_h.*exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(-t.*tau-t.*tau_h+tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./tau+(gs.*tau.*tau_h.*u0.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)-(gs.*tau_h.^2.*u0.*exp(-alpha.*t).*(exp(alpha.*t)-exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)+(beta_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(gamma_centre.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)))+(gs.*tau.*tau_h.*u0.*exp(-alpha.*t).*(exp(alpha.*t)-exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)).*(-1.0./2.0)+(1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(tau.^2.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))-tau.^2.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))+tau_h.^2.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))-tau_h.^2.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))-exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.*tau_h.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*2.0+tau.*tau_h.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*2.0).*(n0+(beta_centre.*tau.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))+(beta_centre.*tau.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(beta_centre.*tau.^2.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau.*tau_h.*2.0+tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.^2-tau_h.^2-gamma_centre.*gh.*tau.*tau_h.*4.0)+(beta_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau.*tau_h.*2.0+tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.^2-tau_h.^2-gamma_centre.*gh.*tau.*tau_h.*4.0)+(beta_centre.*tau.^2.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(beta_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))+alpha.*gamma_centre.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0+tau.*tau_h.*exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(t.*tau+t.*tau_h-tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*gamma_centre.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0-tau.*tau_h.*exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(-t.*tau-t.*tau_h+tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-(I.*gamma_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*2.0)./(tau.*tau_h.*2.0+tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.^2-tau_h.^2-gamma_centre.*gh.*tau.*tau_h.*4.0)+(I.*gamma_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0)./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(gamma_centre.*gs.*tau.*tau_h.*u0.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0)./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)-(gamma_centre.*gs.*tau.*tau_h.*u0.*exp(-alpha.*t).*(exp(alpha.*t)-exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0)./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)).*(1.0./4.0))./(gamma_centre.*tau)) - V_left;

fun3 = @(t,v0,n0,u0,y0) (1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))+tau.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))+tau_h.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))-tau_h.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))).*(-v0+(beta_centre.*tau.^2.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(gamma_centre.*(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*-2.0+gamma_centre.*tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0+gamma_centre.*tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0)+(beta_centre.*tau_h.^2.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(gamma_centre.*(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*-2.0+gamma_centre.*tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0+gamma_centre.*tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0)+(I.*tau_h.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))+(I.*tau_h.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(I.*tau_h.^2.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau.*tau_h.*2.0+tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.^2-tau_h.^2-gamma_centre.*gh.*tau.*tau_h.*4.0)+(beta_centre.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(gamma_centre.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)))-(beta_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(-gamma_centre.*(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+gamma_centre.*tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+gamma_centre.*tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))+(gs.*tau_h.*u0.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)-(beta_centre.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(gamma_centre.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)))-alpha.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0+tau.*tau_h.*exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(t.*tau+t.*tau_h-tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0)+(alpha.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0+tau.*tau_h.*exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(t.*tau+t.*tau_h-tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*t.*tau.*tau_h.*2.0).*2.0).*(1.0./2.0))./tau+alpha.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0-tau.*tau_h.*exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(-t.*tau-t.*tau_h+tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0)+(alpha.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0-tau.*tau_h.*exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(-t.*tau-t.*tau_h+tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+alpha.*t.*tau.*tau_h.*2.0).*2.0).*(1.0./2.0))./tau+(I.*tau.*tau_h.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau.*tau_h.*2.0+tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.^2-tau_h.^2-gamma_centre.*gh.*tau.*tau_h.*4.0)+(I.*tau_h.^2.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(I.*tau.*tau_h.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(gs.*tau_h.^2.*u0.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)-(gs.*tau_h.*u0.*exp(-alpha.*t).*(exp(alpha.*t)-exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)-(beta_centre.*tau.^2.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(gamma_centre.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)))-(beta_centre.*tau_h.^2.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(gamma_centre.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)))+(alpha.*gs.*tau_h.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0+tau.*tau_h.*exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(t.*tau+t.*tau_h-tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./tau-(alpha.*gs.*tau_h.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0-tau.*tau_h.*exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(-t.*tau-t.*tau_h+tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./tau+(gs.*tau.*tau_h.*u0.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)-(gs.*tau_h.^2.*u0.*exp(-alpha.*t).*(exp(alpha.*t)-exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)+(beta_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(gamma_centre.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)))+(gs.*tau.*tau_h.*u0.*exp(-alpha.*t).*(exp(alpha.*t)-exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)).*(-1.0./2.0)+(1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(tau.^2.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))-tau.^2.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))+tau_h.^2.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))-tau_h.^2.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h))-exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.*tau_h.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)-t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*2.0+tau.*tau_h.*exp((t.*tau.*(-1.0./2.0)-t.*tau_h.*(1.0./2.0)+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*(1.0./2.0))./(tau.*tau_h)).*2.0).*(n0+(beta_centre.*tau.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))+(beta_centre.*tau.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(beta_centre.*tau.^2.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau.*tau_h.*2.0+tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.^2-tau_h.^2-gamma_centre.*gh.*tau.*tau_h.*4.0)+(beta_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0))./(tau.*tau_h.*2.0+tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.^2-tau_h.^2-gamma_centre.*gh.*tau.*tau_h.*4.0)+(beta_centre.*tau.^2.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(beta_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))+alpha.*gamma_centre.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0+tau.*tau_h.*exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(t.*tau+t.*tau_h-tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*gamma_centre.*gs.*y0.*(tau.^2.*tau_h.^2.*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*4.0-tau.*tau_h.*exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h)).*1.0./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).^2.*(-t.*tau-t.*tau_h+tau.*tau_h.*2.0+t.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+alpha.*t.*tau.*tau_h.*2.0).*2.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-(I.*gamma_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*2.0)./(tau.*tau_h.*2.0+tau.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)+tau_h.*sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-tau.^2-tau_h.^2-gamma_centre.*gh.*tau.*tau_h.*4.0)+(I.*gamma_centre.*tau.*tau_h.*(exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0)./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0))-(gamma_centre.*gs.*tau.*tau_h.*u0.*(exp((t.*(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0).*(1.0./2.0))./(tau.*tau_h))-1.0).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0)./(tau+tau_h-sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)-(gamma_centre.*gs.*tau.*tau_h.*u0.*exp(-alpha.*t).*(exp(alpha.*t)-exp((t.*(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)).*(1.0./2.0))./(tau.*tau_h))).*1.0./sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0).*2.0)./(tau+tau_h+sqrt(tau.*tau_h.*-2.0+tau.^2+tau_h.^2+gamma_centre.*gh.*tau.*tau_h.*4.0)-alpha.*tau.*tau_h.*2.0)).*(1.0./4.0))./(gamma_centre.*tau)) - V_right;
fun4 = @(t,v0,n0,u0,y0) v0*exp(-t/tau)...
  +(beta_right*gh*(tau-tau_h+tau_h*exp(-t/tau_h)))/(tau-tau_h)...
  -(beta_right*gh*tau*exp(-t/tau))/(tau-tau_h)...
  -(gh*n0*tau_h*exp(-t/tau_h))/(tau-tau_h)...
  +(gh*n0*tau_h*exp(-t/tau))/(tau-tau_h)...
  +(gs*exp(-alpha*t).*(alpha*tau*u0-u0-alpha*t*y0+alpha*tau*y0+alpha^2*t*tau*y0))/(alpha*tau-1)^2 ...
  -(gs*exp(-t/tau)*(alpha*tau*u0-u0+alpha*tau*y0))/(alpha*tau-1)^2 ...
  -I+I*exp(-t/tau)-V_right;

fun5 = @(t,v0,n0,u0,y0) v0*exp(-t/tau)...
  +(beta_right*gh*(tau-tau_h+tau_h*exp(-t/tau_h)))/(tau-tau_h)...
  -(beta_right*gh*tau*exp(-t/tau))/(tau-tau_h)...
  -(gh*n0*tau_h*exp(-t/tau_h))/(tau-tau_h)...
  +(gh*n0*tau_h*exp(-t/tau))/(tau-tau_h)...
  +(gs*exp(-alpha*t).*(alpha*tau*u0-u0-alpha*t*y0+alpha*tau*y0+alpha^2*t*tau*y0))/(alpha*tau-1)^2 ...
  -(gs*exp(-t/tau)*(alpha*tau*u0-u0+alpha*tau*y0))/(alpha*tau-1)^2 ...
  -I+I*exp(-t/tau)-V_th;

% Initialise
X = zeros(5*N,1);
zone = 2*ones(N,1);
eventTime = finalTime*ones(N,1);

% initial_hyp = -spatial_extent+N/2:N/2+spatial_extent;
% X(initial_hyp+N) = rand(size(initial_hyp));

while currentTime<finalTime
  
  Y = networkPropagator(dt,X,zone,alpha,beta_left,beta_centre,beta_right,...
                gamma_centre,tau,tau_h,gh,gs,I,V_r,N);
              
  currentTime = currentTime+dt;
  
  flag = checkEvents(Y,zone,N,V_left,V_right,V_th);
  if any(flag>6)
    fprintf('Flag messed up');
    pause;
  end
%   figure(99);
%   cla;
%   plot(neuron_ind,flag);
%   drawnow;
  
  events = find(flag);
  
  if ~isempty(events)
    for i = 1:length(events)
      index = events(i);
      cross = flag(index);
      v0 = X(index);
      n0 = X(index+N);
      u0 = X(index+2*N);
      y0 = X(index+3*N);
      try
      if cross==1
        eventTime(index) = fzero(@(t)fun1(t,v0,n0,u0,y0),[0,dt],options);
      elseif cross==2
        eventTime(index) = fzero(@(t)fun2(t,v0,n0,u0,y0),[0,dt],options);
      elseif cross==3
        eventTime(index) = fzero(@(t)fun3(t,v0,n0,u0,y0),[0,dt],options);
      elseif cross==4
        eventTime(index) = fzero(@(t)fun4(t,v0,n0,u0,y0),[0,dt],options);
      elseif cross==5
        eventTime(index) = fzero(@(t)fun5(t,v0,n0,u0,y0),[0,dt],options);
      elseif cross==6
        eventTime(index) = X(index+4*N);
      end
      catch
      end
    end
    
    [minEventTime,minEventIndex] = min(eventTime)
    cross = flag(minEventIndex)
    Y = networkPropagator(minEventTime,X,zone,alpha,beta_left,beta_centre,beta_right,...
                gamma_centre,tau,tau_h,gh,gs,I,V_r,N);
              
    if cross==1
      zone(minEventIndex) = 2;
      Y(minEventIndex) = V_left+eps;
    elseif cross==2
      zone(minEventIndex) = 1;
      Y(minEventIndex) = V_left-eps;
    elseif cross==3
      zone(minEventIndex) = 3;
      Y(minEventIndex) = V_right+eps;
    elseif cross==4
      zone(minEventIndex) = 2;
      Y(minEventIndex) = V_right-eps;
    elseif cross==5
      zone(minEventIndex) = 4;
      Y(minEventIndex) = V_r;
      Y(minEventIndex+4*N) = tau_r;
      mask = full_mask+minEventIndex;
      mask(mask<1) = [];
      mask(mask>N) = [];
      Y(mask+3*N)  = Y(mask+3*N)+alpha*W*dx;
    elseif cross==6
      zone(index) = 2;
      Y(minEventIndex+4*N) = 0.0;
    end
    
    % dirty fix to the zoning problem - could also allow backward
    % integration
    zone = ones(N,1);
    zone = zone+(Y(1:N)>=V_left);
    zone = zone+(Y(1:N)>=V_right);
    zone = zone+2*(Y(4*N+1:5*N)>0.0);

    currentTime = currentTime - (dt-minEventTime);
    eventTime = finalTime*ones(N,1);
    
  end
  
  % prepare for next step
  Y(4*N+1:5*N) = Y(4*N+1:5*N).*(Y(4*N+1:5*N)>0.0);
  
  X = Y;
  if any(X(1:N)>V_th)
      pause;
  end
    
  figure(1);
  plotyy(neuron_ind,X(1:N),neuron_ind,zone);
  title(sprintf('Time = %f',currentTime));
  
%   figure(2);cla
%   plot(X);hold on;plot(Y);
%   
%   figure(99);
%   hold on;
%   plot(minEventIndex,flag(minEventIndex),'ro');
  drawnow;
    currentTime

end